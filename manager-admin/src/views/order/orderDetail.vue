<template>
  <div class="order-detail-container">
    <el-row v-if="orderDetail && orderDetail.operateAllowable" :gutter="0">
      <el-col :span="24" style="padding: 10px 20px">
        <el-button
          type="primary"
          size="mini"
          :disabled="!orderDetail.operateAllowable.allowPay"
          @click="confirmPay"
        >确认收款</el-button>
        <el-button
          type="danger"
          size="mini"
          :disabled="!orderDetail.operateAllowable.allowCancel"
          @click="cancelOrder"
        >取消订单</el-button>
      </el-col>
    </el-row>
    <el-row v-for="(row, index) in orderInfo" :key="index" :gutter="0">
      <el-col v-for="col in row" :key="col.key" :span="12">
        <div class="d-header">{{ col.title }}</div>
        <div class="d-content">
          <div v-for="item in col.items" :key="item.key" class="item">
            <span class="item-label" v-html="item.label"></span>
            <span class="item-value">{{ item.value }}</span>
          </div>
        </div>
      </el-col>
    </el-row>
    <el-row v-if="productList" :gutter="0">
      <el-col :span="24">
        <div class="d-header">商品列表</div>
        <el-table :data="productList" :header-cell-style="{textAlign: 'center'}">
          <el-table-column label="商品图片" width="180">
            <template slot-scope="scope">
              <img :src="scope.row.goods_image" class="goods-image"/>
            </template>
          </el-table-column>
          <el-table-column prop="goods_name" label="商品名称" align="left"/>
          <el-table-column label="商品价格" width="150">
            <template slot-scope="scope">{{ scope.row.price | unitPrice('￥') }}</template>
          </el-table-column>
          <el-table-column prop="num" label="购买数量" width="120"/>
          <el-table-column label="小计" width="120">
            <template slot-scope="scope">{{ scope.row.subtotal | unitPrice('￥') }}</template>
          </el-table-column>
        </el-table>
      </el-col>
    </el-row>
    <el-row v-loading="loading_log" :gutter="0">
      <el-col :span="24">
        <div class="d-header">订单日志</div>
        <el-table :data="orderLog" :header-cell-style="{textAlign: 'center'}">
          <el-table-column prop="id" label="操作ID" width="100"/>
          <el-table-column prop="name" label="操作人员" width="200"/>
          <el-table-column label="操作时间" width="250">
            <template slot-scope="scope">{{ scope.row.time | unixToDate }}</template>
          </el-table-column>
          <el-table-column prop="content" label="操作详情" width="400"/>
          <el-table-column/>
        </el-table>
      </el-col>
    </el-row>
  </div>
</template>

<script>
  import * as API_order from '@/api/order'
  import Foundation from '@/framework/Foundation'
  export default {
    name: 'orderDetail',
    data() {
      return {
        /** 列表loading状态 */
        loading: false,
        /** 订单日志loading状态 */
        loading_log: false,
        /** 订单详情数据 */
        orderDetail: null,
        /** 订单日志 */
        orderLog: [],
        /** 订单sn */
        sn: this.$route.params.sn,
        /** 基本信息、发票信息、买家信息、商家信息 */
        orderInfo: [],
        /** 产品列表 */
        productList: null
      }
    },
    filters: {
      paymentTypeFilter(val) {
        return val === 'online' ? '在线支付' : '货到付款'
      },
      unixToDate(val) {
        return Foundation.unixToDate(val)
      }
    },
    mounted() {
      this.GET_OrderDetail()
      this.GET_OrderLog()
    },
    methods: {
      GET_OrderDetail() {
        this.loading = true
        API_order.getOrderDetail(this.sn).then(response => {
          this.loading = false
          this.orderDetail = response
          this.productList = response.productList
          this.countShowData()
        }).catch(error => {
          this.loading = false
          console.log(error)
        })
      },

      /** 获取订单日志 */
      GET_OrderLog() {
        this.loading_log = true
        API_order.getOrderLog(this.sn).then(response => {
          this.loading_log = false
          this.orderLog = response
        }).catch(error => {
          this.loading_log = false
          console.log(error)
        })
      },

      /** 确认收款 */
      confirmPay() {
        this.$confirm('确定要确认收款吗？', '提示', { type: 'warning' }).then(() => {
          API_order.confirmPay(this.sn, { payprice: this.orderDetail.order_price }).then(response => {
            this.$message.success('订单确认收款成功！')
            this.GET_OrderDetail()
          }).catch(error => console.log(error))
        }).catch(() => {})
      },

      /** 取消订单 */
      cancelOrder() {
        this.$confirm('确定要取消这个订单吗？', '提示', { type: 'warning' }).then(() => {
          API_order.cancleOrder(this.sn).then(() => {
            this.$message.success('订单取消成功！')
            this.GET_OrderDetail()
          }).catch(error => console.log(error))
        }).catch(() => {})
      },

      /** 组合基本信息、发票信息、买家信息、商家信息 */
      countShowData() {
        const o = this.orderDetail
        const f = Foundation
        this.orderInfo = [
          [
            {
              title: '基本信息',
              key: 'base',
              items: [
                { label: '订单编号', value: o.sn },
                { label: '订单金额', value: '￥' + f.formatPrice(o.need_pay_money) },
                { label: '支付方式', value: o.payment_type_text },
                { label: '订单状态', value: o.order_status_text + (o.cancel_reason ? '（' + o.cancel_reason + '）' : '') },
                { label: '下单时间', value: f.unixToDate(o.order_time) }
              ]
            },
            {
              title: '发票信息',
              key: 'receipt',
              items: [
                { label: '发票类型', value: o.need_receipt ? (o.receipt_type === 'PERSON' ? '个人' : '单位') : '无' },
                { label: '发票抬头', value: o.need_receipt ? o.receipt_title || '无' : '无' },
                { label: '发票内容', value: o.need_receipt ? o.receipt_content || '无' : '无' },
                { label: '发票税号', value: o.need_receipt ? o.duty_invoice || '无' : '无' }
              ]
            }
          ],
          [
            {
              title: '买家信息',
              key: 'buyer',
              items: [
                { label: '收&ensp;货&ensp;人', value: o.ship_name },
                { label: '收货地址', value: o.ship_province + o.ship_city + o.ship_region + o.ship_town + ' ' + o.ship_addr },
                { label: '联系方式', value: o.ship_mobile },
                { label: '买家留言', value: o.remark || '无' }
              ]
            },
            {
              title: '商家信息',
              key: 'seller',
              items: [
                { label: '卖家账号', value: o.seller_name },
                { label: '发货时间', value: f.unixToDate(o.ship_time) },
                { label: '物流公司', value: o.logi_name },
                { label: '快递单号', value: o.ship_no }
              ]
            }
          ]
        ]
      }
    }
  }
</script>

<style type="text/scss" lang="scss" scoped>
  .order-detail-container {
    background-color: #fff;
  }

  .d-header {
    padding: 10px 0 10px 20px;
    font-size: 14px;
    color: #333;
    background-color: #f5f7fa;
    border-bottom: 1px solid #e1e8ed;

    &h2 {
      font-size: 14px;
      font-weight: 400;
    }
  }

  .item {
    width: 100%;
    position: relative;
    display: inline-block;
    vertical-align: top;
    box-sizing: border-box;
    padding: 16px 0 16px 20px;
    line-height: 24px;
    white-space: nowrap;

    & .item-label {
      float: left;
      margin-right: 20px;
      font-size: 14px;
      color: #999;
    }
    & .item-value {
      overflow: hidden;
      white-space: normal;
      word-break: break-all;
      font-size: 14px;
      color: #666;
    }
  }

  /deep/ .el-table td:not(.is-left) {
    text-align: center;
  }

  .goods-image {
    width: 50px;
    height: 50px;
  }
</style>

